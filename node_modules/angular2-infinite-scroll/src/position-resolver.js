"use strict";
var core_1 = require('@angular/core');
var axis_resolver_1 = require('./axis-resolver');
var PositionResolverFactory = (function () {
    function PositionResolverFactory(axisResolver) {
        this.axisResolver = axisResolver;
    }
    PositionResolverFactory.prototype.create = function (options) {
        return new PositionResolver(this.axisResolver.create(!options.horizontal), options);
    };
    PositionResolverFactory.decorators = [
        { type: core_1.Injectable },
    ];
    /** @nocollapse */
    PositionResolverFactory.ctorParameters = [
        { type: axis_resolver_1.AxisResolverFactory, },
    ];
    return PositionResolverFactory;
}());
exports.PositionResolverFactory = PositionResolverFactory;
var PositionResolver = (function () {
    function PositionResolver(axis, options) {
        this.axis = axis;
        this.options = options;
        this.resolveContainer(this.options.windowElement);
        this.defineContainer(this.options.windowElement);
    }
    PositionResolver.prototype.defineContainer = function (windowElement) {
        if (this.resolveContainer(windowElement) || !windowElement.nativeElement) {
            this.container = windowElement;
        }
        else {
            this.container = windowElement.nativeElement;
        }
        return this.container;
    };
    PositionResolver.prototype.resolveContainer = function (windowElement) {
        var isContainerWindow = Object.prototype.toString.call(windowElement).includes('Window');
        this.isContainerWindow = isContainerWindow;
        return isContainerWindow;
    };
    PositionResolver.prototype.getDocumentElement = function () {
        return this.isContainerWindow
            ? this.options.windowElement.document.documentElement
            : null;
    };
    PositionResolver.prototype.calculatePoints = function (element) {
        return this.isContainerWindow
            ? this.calculatePointsForWindow(element)
            : this.calculatePointsForElement(element);
    };
    PositionResolver.prototype.calculatePointsForWindow = function (element) {
        // container's height
        var height = this.height(this.container);
        // scrolled until now / current y point
        var scrolledUntilNow = height + this.pageYOffset(this.getDocumentElement());
        // total height / most bottom y point
        var totalToScroll = this.offsetTop(element.nativeElement) + this.height(element.nativeElement);
        return { height: height, scrolledUntilNow: scrolledUntilNow, totalToScroll: totalToScroll };
    };
    PositionResolver.prototype.calculatePointsForElement = function (element) {
        var scrollTop = this.axis.scrollTopKey();
        var scrollHeight = this.axis.scrollHeightKey();
        var container = this.container;
        var height = this.height(container);
        // perhaps use this.container.offsetTop instead of 'scrollTop'
        var scrolledUntilNow = container[scrollTop];
        var containerTopOffset = 0;
        var offsetTop = this.offsetTop(container);
        if (offsetTop !== void 0) {
            containerTopOffset = offsetTop;
        }
        var totalToScroll = container[scrollHeight];
        return { height: height, scrolledUntilNow: scrolledUntilNow, totalToScroll: totalToScroll };
    };
    PositionResolver.prototype.height = function (elem) {
        var offsetHeight = this.axis.offsetHeightKey();
        var clientHeight = this.axis.clientHeightKey();
        // elem = elem.nativeElement;
        if (isNaN(elem[offsetHeight])) {
            return this.getDocumentElement()[clientHeight];
        }
        else {
            return elem[offsetHeight];
        }
    };
    PositionResolver.prototype.offsetTop = function (elem) {
        var top = this.axis.topKey();
        // elem = elem.nativeElement;
        if (!elem.getBoundingClientRect) {
            return;
        }
        return elem.getBoundingClientRect()[top] + this.pageYOffset(elem);
    };
    PositionResolver.prototype.pageYOffset = function (elem) {
        var pageYOffset = this.axis.pageYOffsetKey();
        var scrollTop = this.axis.scrollTopKey();
        var offsetTop = this.axis.offsetTopKey();
        // elem = elem.nativeElement;
        if (isNaN(window[pageYOffset])) {
            return this.getDocumentElement()[scrollTop];
        }
        else if (elem.ownerDocument) {
            return elem.ownerDocument.defaultView[pageYOffset];
        }
        else {
            return elem[offsetTop];
        }
    };
    return PositionResolver;
}());
exports.PositionResolver = PositionResolver;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zaXRpb24tcmVzb2x2ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwb3NpdGlvbi1yZXNvbHZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUJBQXVDLGVBQWUsQ0FBQyxDQUFBO0FBQ3ZELDhCQUFrRCxpQkFBaUIsQ0FBQyxDQUFBO0FBSXBFO0lBRUUsaUNBQW9CLFlBQWlDO1FBQWpDLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtJQUNyRCxDQUFDO0lBRUQsd0NBQU0sR0FBTixVQUFRLE9BQXlCO1FBQy9CLE1BQU0sQ0FBQyxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3RGLENBQUM7SUFDSSxrQ0FBVSxHQUEwQjtRQUMzQyxFQUFFLElBQUksRUFBRSxpQkFBVSxFQUFFO0tBQ25CLENBQUM7SUFDRixrQkFBa0I7SUFDWCxzQ0FBYyxHQUE2RDtRQUNsRixFQUFDLElBQUksRUFBRSxtQ0FBbUIsR0FBRztLQUM1QixDQUFDO0lBQ0YsOEJBQUM7QUFBRCxDQUFDLEFBZkQsSUFlQztBQWZZLCtCQUF1QiwwQkFlbkMsQ0FBQTtBQUVEO0lBS0UsMEJBQXFCLElBQWtCLEVBQVUsT0FBeUI7UUFBckQsU0FBSSxHQUFKLElBQUksQ0FBYztRQUFVLFlBQU8sR0FBUCxPQUFPLENBQWtCO1FBQ3hFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQsMENBQWUsR0FBZixVQUFnQixhQUEyQjtRQUN6QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxD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QUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7WUFDOUIsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDekIsQ0FBQztJQUNILENBQUM7SUFDSCx1QkFBQztBQUFELENBQUMsQUFwR0QsSUFvR0M7QUFwR1ksd0JBQWdCLG1CQW9HNUIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEF4aXNSZXNvbHZlciwgQXhpc1Jlc29sdmVyRmFjdG9yeSB9IGZyb20gJy4vYXhpcy1yZXNvbHZlcic7XG5pbXBvcnQgeyBDb250YWluZXJSZWYsIFBvc2l0aW9uRWxlbWVudHMsIFBvc2l0aW9uU3RhdHMgfSBmcm9tICcuL21vZGVscyc7XG5cblxuZXhwb3J0IGNsYXNzIFBvc2l0aW9uUmVzb2x2ZXJGYWN0b3J5IHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGF4aXNSZXNvbHZlcjogQXhpc1Jlc29sdmVyRmFjdG9yeSkge1xuICB9XG5cbiAgY3JlYXRlIChvcHRpb25zOiBQb3NpdGlvbkVsZW1lbnRzKSB7XG4gICAgcmV0dXJuIG5ldyBQb3NpdGlvblJlc29sdmVyKHRoaXMuYXhpc1Jlc29sdmVyLmNyZWF0ZSghb3B0aW9ucy5ob3Jpem9udGFsKSwgb3B0aW9ucyk7XG4gIH1cbnN0YXRpYyBkZWNvcmF0b3JzOiBEZWNvcmF0b3JJbnZvY2F0aW9uW10gPSBbXG57IHR5cGU6IEluamVjdGFibGUgfSxcbl07XG4vKiogQG5vY29sbGFwc2UgKi9cbnN0YXRpYyBjdG9yUGFyYW1ldGVyczogKHt0eXBlOiBhbnksIGRlY29yYXRvcnM/OiBEZWNvcmF0b3JJbnZvY2F0aW9uW119fG51bGwpW10gPSBbXG57dHlwZTogQXhpc1Jlc29sdmVyRmFjdG9yeSwgfSxcbl07XG59XG5cbmV4cG9ydCBjbGFzcyBQb3NpdGlvblJlc29sdmVyIHtcbiAgcHJpdmF0ZSBkb2N1bWVudEVsZW1lbnQ6IENvbnRhaW5lclJlZjtcbiAgcHJpdmF0ZSBpc0NvbnRhaW5lcldpbmRvdzogYm9vbGVhbjtcbiAgcHVibGljIGNvbnRhaW5lcjogQ29udGFpbmVyUmVmO1xuXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIGF4aXM6IEF4aXNSZXNvbHZlciwgcHJpdmF0ZSBvcHRpb25zOiBQb3NpdGlvbkVsZW1lbnRzKSB7XG4gICAgdGhpcy5yZXNvbHZlQ29udGFpbmVyKHRoaXMub3B0aW9ucy53aW5kb3dFbGVtZW50KTtcbiAgICB0aGlzLmRlZmluZUNvbnRhaW5lcih0aGlzLm9wdGlvbnMud2luZG93RWxlbWVudCk7XG4gIH1cblxuICBkZWZpbmVDb250YWluZXIod2luZG93RWxlbWVudDogQ29udGFpbmVyUmVmKSB7XG4gICAgaWYgKHRoaXMucmVzb2x2ZUNvbnRhaW5lcih3aW5kb3dFbGVtZW50KSB8fCAhd2luZG93RWxlbWVudC5uYXRpdmVFbGVtZW50KSB7XG4gICAgICB0aGlzLmNvbnRhaW5lciA9IHdpbmRvd0VsZW1lbnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29udGFpbmVyID0gd2luZG93RWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7XG4gIH1cblxuICByZXNvbHZlQ29udGFpbmVyKHdpbmRvd0VsZW1lbnQ6IENvbnRhaW5lclJlZik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlzQ29udGFpbmVyV2luZG93ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHdpbmRvd0VsZW1lbnQpLmluY2x1ZGVzKCdXaW5kb3cnKTtcbiAgICB0aGlzLmlzQ29udGFpbmVyV2luZG93ID0gaXNDb250YWluZXJXaW5kb3c7XG4gICAgcmV0dXJuIGlzQ29udGFpbmVyV2luZG93O1xuICB9XG5cbiAgZ2V0RG9jdW1lbnRFbGVtZW50KCkge1xuICAgIHJldHVybiB0aGlzLmlzQ29udGFpbmVyV2luZG93XG4gICAgICA/IHRoaXMub3B0aW9ucy53aW5kb3dFbGVtZW50LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFxuICAgICAgOiBudWxsO1xuICB9XG5cbiAgY2FsY3VsYXRlUG9pbnRzIChlbGVtZW50OiBFbGVtZW50UmVmKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNDb250YWluZXJXaW5kb3dcbiAgICAgID8gdGhpcy5jYWxjdWxhdGVQb2ludHNGb3JXaW5kb3coZWxlbWVudClcbiAgICAgIDogdGhpcy5jYWxjdWxhdGVQb2ludHNGb3JFbGVtZW50KGVsZW1lbnQpO1xuICB9XG5cbiAgY2FsY3VsYXRlUG9pbnRzRm9yV2luZG93IChlbGVtZW50OiBFbGVtZW50UmVmKTogUG9zaXRpb25TdGF0cyB7XG4gICAgLy8gY29udGFpbmVyJ3MgaGVpZ2h0XG4gICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5oZWlnaHQodGhpcy5jb250YWluZXIpO1xuICAgIC8vIHNjcm9sbGVkIHVudGlsIG5vdyAvIGN1cnJlbnQgeSBwb2ludFxuICAgIGNvbnN0IHNjcm9sbGVkVW50aWxOb3cgPSBoZWlnaHQgKyB0aGlzLnBhZ2VZT2Zmc2V0KHRoaXMuZ2V0RG9jdW1lbnRFbGVtZW50KCkpO1xuICAgIC8vIHRvdGFsIGhlaWdodCAvIG1vc3QgYm90dG9tIHkgcG9pbnRcbiAgICBjb25zdCB0b3RhbFRvU2Nyb2xsID0gdGhpcy5vZmZzZXRUb3AoZWxlbWVudC5uYXRpdmVFbGVtZW50KSArIHRoaXMuaGVpZ2h0KGVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gICAgcmV0dXJuIHsgaGVpZ2h0LCBzY3JvbGxlZFVudGlsTm93LCB0b3RhbFRvU2Nyb2xsIH07XG4gIH1cblxuICBjYWxjdWxhdGVQb2ludHNGb3JFbGVtZW50IChlbGVtZW50OiBFbGVtZW50UmVmKSB7XG4gICAgbGV0IHNjcm9sbFRvcCAgICA9IHRoaXMuYXhpcy5zY3JvbGxUb3BLZXkoKTtcbiAgICBsZXQgc2Nyb2xsSGVpZ2h0ID0gdGhpcy5heGlzLnNjcm9sbEhlaWdodEtleSgpO1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyO1xuXG4gICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5oZWlnaHQoY29udGFpbmVyKTtcbiAgICAvLyBwZXJoYXBzIHVzZSB0aGlzLmNvbnRhaW5lci5vZmZzZXRUb3AgaW5zdGVhZCBvZiAnc2Nyb2xsVG9wJ1xuICAgIGNvbnN0IHNjcm9sbGVkVW50aWxOb3cgPSBjb250YWluZXJbc2Nyb2xsVG9wXTtcbiAgICBsZXQgY29udGFpbmVyVG9wT2Zmc2V0ID0gMDtcbiAgICBjb25zdCBvZmZzZXRUb3AgPSB0aGlzLm9mZnNldFRvcChjb250YWluZXIpO1xuICAgIGlmIChvZmZzZXRUb3AgIT09IHZvaWQgMCkge1xuICAgICAgY29udGFpbmVyVG9wT2Zmc2V0ID0gb2Zmc2V0VG9wO1xuICAgIH1cbiAgICBjb25zdCB0b3RhbFRvU2Nyb2xsID0gY29udGFpbmVyW3Njcm9sbEhlaWdodF07XG4gICAgcmV0dXJuIHsgaGVpZ2h0LCBzY3JvbGxlZFVudGlsTm93LCB0b3RhbFRvU2Nyb2xsIH07XG4gIH1cblxuICBwcml2YXRlIGhlaWdodCAoZWxlbTogYW55KSB7XG4gICAgbGV0IG9mZnNldEhlaWdodCA9IHRoaXMuYXhpcy5vZmZzZXRIZWlnaHRLZXkoKTtcbiAgICBsZXQgY2xpZW50SGVpZ2h0ID0gdGhpcy5heGlzLmNsaWVudEhlaWdodEtleSgpO1xuXG4gICAgLy8gZWxlbSA9IGVsZW0ubmF0aXZlRWxlbWVudDtcbiAgICBpZiAoaXNOYU4oZWxlbVtvZmZzZXRIZWlnaHRdKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0RG9jdW1lbnRFbGVtZW50KClbY2xpZW50SGVpZ2h0XTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGVsZW1bb2Zmc2V0SGVpZ2h0XTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9mZnNldFRvcCAoZWxlbTogYW55KSB7XG4gICAgbGV0IHRvcCA9IHRoaXMuYXhpcy50b3BLZXkoKTtcblxuICAgIC8vIGVsZW0gPSBlbGVtLm5hdGl2ZUVsZW1lbnQ7XG4gICAgaWYgKCFlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCkgeyAvLyB8fCBlbGVtLmNzcygnbm9uZScpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHJldHVybiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpW3RvcF0gKyB0aGlzLnBhZ2VZT2Zmc2V0KGVsZW0pO1xuICB9XG5cbiAgcGFnZVlPZmZzZXQgKGVsZW06IGFueSkge1xuICAgIGxldCBwYWdlWU9mZnNldCA9IHRoaXMuYXhpcy5wYWdlWU9mZnNldEtleSgpO1xuICAgIGxldCBzY3JvbGxUb3AgICA9IHRoaXMuYXhpcy5zY3JvbGxUb3BLZXkoKTtcbiAgICBsZXQgb2Zmc2V0VG9wICAgPSB0aGlzLmF4aXMub2Zmc2V0VG9wS2V5KCk7XG5cbiAgICAvLyBlbGVtID0gZWxlbS5uYXRpdmVFbGVtZW50O1xuICAgIGlmIChpc05hTih3aW5kb3dbcGFnZVlPZmZzZXRdKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0RG9jdW1lbnRFbGVtZW50KClbc2Nyb2xsVG9wXTtcbiAgICB9IGVsc2UgaWYgKGVsZW0ub3duZXJEb2N1bWVudCkge1xuICAgICAgcmV0dXJuIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0Vmlld1twYWdlWU9mZnNldF07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBlbGVtW29mZnNldFRvcF07XG4gICAgfVxuICB9XG59XG5cbmludGVyZmFjZSBEZWNvcmF0b3JJbnZvY2F0aW9uIHtcbiAgdHlwZTogRnVuY3Rpb247XG4gIGFyZ3M/OiBhbnlbXTtcbn1cbiJdfQ==