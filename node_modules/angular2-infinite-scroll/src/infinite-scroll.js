"use strict";
var core_1 = require('@angular/core');
var position_resolver_1 = require('./position-resolver');
var scroll_register_1 = require('./scroll-register');
var scroll_resolver_1 = require('./scroll-resolver');
var InfiniteScroll = (function () {
    function InfiniteScroll(element, zone, positionResolverFactory, scrollRegister, scrollerResolver) {
        this.element = element;
        this.zone = zone;
        this.positionResolverFactory = positionResolverFactory;
        this.scrollRegister = scrollRegister;
        this.scrollerResolver = scrollerResolver;
        this.scrolled = new core_1.EventEmitter();
        this.scrolledUp = new core_1.EventEmitter();
        this._distanceDown = 2;
        this._distanceUp = 1.5;
        this._throttle = 300;
        this._disabled = false;
        this._container = null;
        this.scrollWindow = true;
        this._immediate = false;
        this._horizontal = false;
        this._alwaysCallback = false;
        this.throttleType = 'throttle';
    }
    Object.defineProperty(InfiniteScroll.prototype, "debounce", {
        set: function (value) {
            this.throttleType = value === '' || !!value ? 'debounce' : 'throttle';
        },
        enumerable: true,
        configurable: true
    });
    InfiniteScroll.prototype.ngOnInit = function () {
        var _this = this;
        if (typeof window !== 'undefined') {
            var containerElement = this.resolveContainerElement();
            var positionResolver_1 = this.positionResolverFactory.create({
                windowElement: containerElement,
                horizontal: this._horizontal
            });
            var options = {
                container: positionResolver_1.container,
                throttleType: this.throttleType,
                throttleDuration: this._throttle,
                filterBefore: function () { return !_this._disabled; },
                mergeMap: function () { return positionResolver_1.calculatePoints(_this.element); },
                scrollHandler: function (container) { return _this.handleOnScroll(container); }
            };
            this.disposeScroller = this.scrollRegister.attachEvent(options);
        }
    };
    InfiniteScroll.prototype.handleOnScroll = function (container) {
        var scrollResolverConfig = {
            distance: {
                down: this._distanceDown,
                up: this._distanceUp
            }
        };
        var scrollStats = this.scrollerResolver.getScrollStats(container, scrollResolverConfig);
        if (this.shouldTriggerEvents(scrollStats.shouldScroll)) {
            var infiniteScrollEvent = {
                currentScrollPosition: container.scrolledUntilNow
            };
            if (scrollStats.isScrollingDown) {
                this.onScrollDown(infiniteScrollEvent);
            }
            else {
                this.onScrollUp(infiniteScrollEvent);
            }
        }
    };
    InfiniteScroll.prototype.shouldTriggerEvents = function (shouldScroll) {
        return (this._alwaysCallback || shouldScroll) && !this._disabled;
    };
    InfiniteScroll.prototype.ngOnDestroy = function () {
        if (this.disposeScroller) {
            this.disposeScroller.unsubscribe();
        }
    };
    InfiniteScroll.prototype.onScrollDown = function (data) {
        var _this = this;
        if (data === void 0) { data = { currentScrollPosition: 0 }; }
        this.zone.run(function () { return _this.scrolled.emit(data); });
    };
    InfiniteScroll.prototype.onScrollUp = function (data) {
        var _this = this;
        if (data === void 0) { data = { currentScrollPosition: 0 }; }
        this.zone.run(function () { return _this.scrolledUp.emit(data); });
    };
    InfiniteScroll.prototype.resolveContainerElement = function () {
        if (this._container) {
            return typeof (this._container) === 'string' ? window.document.querySelector(this._container) : this._container;
        }
        else {
            return this.scrollWindow ? window : this.element;
        }
    };
    InfiniteScroll.decorators = [
        { type: core_1.Directive, args: [{
                    selector: '[infinite-scroll]'
                },] },
    ];
    /** @nocollapse */
    InfiniteScroll.ctorParameters = [
        { type: core_1.ElementRef, },
        { type: core_1.NgZone, },
        { type: position_resolver_1.PositionResolverFactory, },
        { type: scroll_register_1.ScrollRegister, },
        { type: scroll_resolver_1.ScrollResolver, },
    ];
    InfiniteScroll.propDecorators = {
        'scrolled': [{ type: core_1.Output },],
        'scrolledUp': [{ type: core_1.Output },],
        '_distanceDown': [{ type: core_1.Input, args: ['infiniteScrollDistance',] },],
        '_distanceUp': [{ type: core_1.Input, args: ['infiniteScrollUpDistance',] },],
        '_throttle': [{ type: core_1.Input, args: ['infiniteScrollThrottle',] },],
        '_disabled': [{ type: core_1.Input, args: ['infiniteScrollDisabled',] },],
        '_container': [{ type: core_1.Input, args: ['infiniteScrollContainer',] },],
        'scrollWindow': [{ type: core_1.Input, args: ['scrollWindow',] },],
        '_immediate': [{ type: core_1.Input, args: ['immediateCheck',] },],
        '_horizontal': [{ type: core_1.Input, args: ['horizontal',] },],
        '_alwaysCallback': [{ type: core_1.Input, args: ['alwaysCallback',] },],
        'debounce': [{ type: core_1.Input },],
    };
    return InfiniteScroll;
}());
exports.InfiniteScroll = InfiniteScroll;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5maW5pdGUtc2Nyb2xsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW5maW5pdGUtc2Nyb2xsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxxQkFJTyxlQUFlLENBQUMsQ0FBQTtBQUN2QixrQ0FBd0MscUJBQXFCLENBQUMsQ0FBQTtBQUM5RCxnQ0FBcUQsbUJBQW1CLENBQUMsQ0FBQTtBQUN6RSxnQ0FBK0IsbUJBQW1CLENBQUMsQ0FBQTtBQUtuRDtJQXFCRSx3QkFDVSxPQUFtQixFQUNuQixJQUFZLEVBQ1osdUJBQWdELEVBQ2hELGNBQThCLEVBQzlCLGdCQUFnQztRQUpoQyxZQUFPLEdBQVAsT0FBTyxDQUFZO1FBQ25CLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBQ2hELG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWdCO1FBekJ6QyxhQUFRLEdBQUcsSUFBSSxtQkFBWSxFQUF1QixDQUFDO1FBQ25ELGVBQVUsR0FBRyxJQUFJLG1CQUFZLEVBQXVCLENBQUM7UUFFckQsa0JBQWEsR0FBVyxDQUFDLENBQUM7UUFDMUIsZ0JBQVcsR0FBVyxHQUFHLENBQUM7UUFDMUIsY0FBUyxHQUFXLEdBQUcsQ0FBQztRQUN4QixjQUFTLEdBQVksS0FBSyxDQUFDO1FBQzNCLGVBQVUsR0FBUSxJQUFJLENBQUM7UUFDdkIsaUJBQVksR0FBWSxJQUFJLENBQUM7UUFDN0IsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUM1QixnQkFBVyxHQUFZLEtBQUssQ0FBQztRQUM3QixvQkFBZSxHQUFZLEtBQUssQ0FBQztRQU0xQixpQkFBWSxHQUFXLFVBQVUsQ0FBQztJQVN2QyxDQUFDO0lBYkosc0JBQUksb0NBQVE7YUFBWixVQUFhLEtBQXVCO1lBQ2xDLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsS0FBSyxHQUFHLFVB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bnRlbnQiOlsiaW1wb3J0IHsgSW5maW5pdGVTY3JvbGxFdmVudCwgU2Nyb2xsU3RhdHMsIFBvc2l0aW9uU3RhdHMgfSBmcm9tICcuL21vZGVscyc7XG5pbXBvcnQge1xuICBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIElucHV0LCBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlciwgT25EZXN0cm95LCBPbkluaXQsXG4gIFNpbXBsZUNoYW5nZXMsIE5nWm9uZVxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFBvc2l0aW9uUmVzb2x2ZXJGYWN0b3J5IH0gZnJvbSAnLi9wb3NpdGlvbi1yZXNvbHZlcic7XG5pbXBvcnQgeyBTY3JvbGxSZWdpc3RlciwgU2Nyb2xsUmVnaXN0ZXJDb25maWcgfSBmcm9tICcuL3Njcm9sbC1yZWdpc3Rlcic7XG5pbXBvcnQgeyBTY3JvbGxSZXNvbHZlciB9IGZyb20gJy4vc2Nyb2xsLXJlc29sdmVyJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMvUngnO1xuXG5cblxuZXhwb3J0IGNsYXNzIEluZmluaXRlU2Nyb2xsIGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQge1xuICAgc2Nyb2xsZWQgPSBuZXcgRXZlbnRFbWl0dGVyPEluZmluaXRlU2Nyb2xsRXZlbnQ+KCk7XG4gICBzY3JvbGxlZFVwID0gbmV3IEV2ZW50RW1pdHRlcjxJbmZpbml0ZVNjcm9sbEV2ZW50PigpO1xuXG4gICBfZGlzdGFuY2VEb3duOiBudW1iZXIgPSAyO1xuICAgX2Rpc3RhbmNlVXA6IG51bWJlciA9IDEuNTtcbiAgIF90aHJvdHRsZTogbnVtYmVyID0gMzAwO1xuICAgX2Rpc2FibGVkOiBib29sZWFuID0gZmFsc2U7XG4gICBfY29udGFpbmVyOiBhbnkgPSBudWxsO1xuICAgc2Nyb2xsV2luZG93OiBib29sZWFuID0gdHJ1ZTtcbiAgIF9pbW1lZGlhdGU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgIF9ob3Jpem9udGFsOiBib29sZWFuID0gZmFsc2U7XG4gICBfYWx3YXlzQ2FsbGJhY2s6IGJvb2xlYW4gPSBmYWxzZTtcbiAgXG4gIHNldCBkZWJvdW5jZSh2YWx1ZTogc3RyaW5nIHwgYm9vbGVhbikge1xuICAgIHRoaXMudGhyb3R0bGVUeXBlID0gdmFsdWUgPT09ICcnIHx8ICEhdmFsdWUgPyAnZGVib3VuY2UnIDogJ3Rocm90dGxlJztcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3R0bGVUeXBlOiBzdHJpbmcgPSAndGhyb3R0bGUnO1xuICBwcml2YXRlIGRpc3Bvc2VTY3JvbGxlcjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBwcml2YXRlIHBvc2l0aW9uUmVzb2x2ZXJGYWN0b3J5OiBQb3NpdGlvblJlc29sdmVyRmFjdG9yeSxcbiAgICBwcml2YXRlIHNjcm9sbFJlZ2lzdGVyOiBTY3JvbGxSZWdpc3RlcixcbiAgICBwcml2YXRlIHNjcm9sbGVyUmVzb2x2ZXI6IFNjcm9sbFJlc29sdmVyXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGNvbnN0IGNvbnRhaW5lckVsZW1lbnQgPSB0aGlzLnJlc29sdmVDb250YWluZXJFbGVtZW50KCk7XG4gICAgICBjb25zdCBwb3NpdGlvblJlc29sdmVyID0gdGhpcy5wb3NpdGlvblJlc29sdmVyRmFjdG9yeS5jcmVhdGUoe1xuICAgICAgICB3aW5kb3dFbGVtZW50OiBjb250YWluZXJFbGVtZW50LFxuICAgICAgICBob3Jpem9udGFsOiB0aGlzLl9ob3Jpem9udGFsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IG9wdGlvbnM6IFNjcm9sbFJlZ2lzdGVyQ29uZmlnID0ge1xuICAgICAgICBjb250YWluZXI6IHBvc2l0aW9uUmVzb2x2ZXIuY29udGFpbmVyLFxuICAgICAgICB0aHJvdHRsZVR5cGU6IHRoaXMudGhyb3R0bGVUeXBlLFxuICAgICAgICB0aHJvdHRsZUR1cmF0aW9uOiB0aGlzLl90aHJvdHRsZSxcbiAgICAgICAgZmlsdGVyQmVmb3JlOiAoKSA9PiAhdGhpcy5fZGlzYWJsZWQsXG4gICAgICAgIG1lcmdlTWFwOiAoKSA9PiBwb3NpdGlvblJlc29sdmVyLmNhbGN1bGF0ZVBvaW50cyh0aGlzLmVsZW1lbnQpLFxuICAgICAgICBzY3JvbGxIYW5kbGVyOiAoY29udGFpbmVyOiBQb3NpdGlvblN0YXRzKSA9PiB0aGlzLmhhbmRsZU9uU2Nyb2xsKGNvbnRhaW5lcilcbiAgICAgIH07XG4gICAgICB0aGlzLmRpc3Bvc2VTY3JvbGxlciA9IHRoaXMuc2Nyb2xsUmVnaXN0ZXIuYXR0YWNoRXZlbnQob3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlT25TY3JvbGwoY29udGFpbmVyOiBQb3NpdGlvblN0YXRzKSB7XG4gICAgY29uc3Qgc2Nyb2xsUmVzb2x2ZXJDb25maWcgPSB7XG4gICAgICBkaXN0YW5jZToge1xuICAgICAgICBkb3duOiB0aGlzLl9kaXN0YW5jZURvd24sXG4gICAgICAgIHVwOiB0aGlzLl9kaXN0YW5jZVVwXG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCBzY3JvbGxTdGF0czogU2Nyb2xsU3RhdHMgPSB0aGlzLnNjcm9sbGVyUmVzb2x2ZXIuZ2V0U2Nyb2xsU3RhdHMoY29udGFpbmVyLCBzY3JvbGxSZXNvbHZlckNvbmZpZyk7XG4gICAgaWYgKHRoaXMuc2hvdWxkVHJpZ2dlckV2ZW50cyhzY3JvbGxTdGF0cy5zaG91bGRTY3JvbGwpKSB7XG4gICAgICBjb25zdCBpbmZpbml0ZVNjcm9sbEV2ZW50OiBJbmZpbml0ZVNjcm9sbEV2ZW50ID0ge1xuICAgICAgICBjdXJyZW50U2Nyb2xsUG9zaXRpb246IGNvbnRhaW5lci5zY3JvbGxlZFVudGlsTm93XG4gICAgICB9O1xuICAgICAgaWYgKHNjcm9sbFN0YXRzLmlzU2Nyb2xsaW5nRG93bikge1xuICAgICAgICB0aGlzLm9uU2Nyb2xsRG93bihpbmZpbml0ZVNjcm9sbEV2ZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMub25TY3JvbGxVcChpbmZpbml0ZVNjcm9sbEV2ZW50KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzaG91bGRUcmlnZ2VyRXZlbnRzKHNob3VsZFNjcm9sbDogYm9vbGVhbikge1xuICAgIHJldHVybiAodGhpcy5fYWx3YXlzQ2FsbGJhY2sgfHwgc2hvdWxkU2Nyb2xsKSAmJiAhdGhpcy5fZGlzYWJsZWQ7XG4gIH1cblxuICBuZ09uRGVzdHJveSAoKSB7XG4gICAgaWYgKHRoaXMuZGlzcG9zZVNjcm9sbGVyKSB7XG4gICAgICB0aGlzLmRpc3Bvc2VTY3JvbGxlci51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIG9uU2Nyb2xsRG93bihkYXRhOiBJbmZpbml0ZVNjcm9sbEV2ZW50ID0geyBjdXJyZW50U2Nyb2xsUG9zaXRpb246IDAgfSkge1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4gdGhpcy5zY3JvbGxlZC5lbWl0KGRhdGEpKTtcbiAgfVxuXG4gIG9uU2Nyb2xsVXAoZGF0YTogSW5maW5pdGVTY3JvbGxFdmVudCA9IHsgY3VycmVudFNjcm9sbFBvc2l0aW9uOiAwIH0pIHtcbiAgICB0aGlzLnpvbmUucnVuKCgpID0+IHRoaXMuc2Nyb2xsZWRVcC5lbWl0KGRhdGEpKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzb2x2ZUNvbnRhaW5lckVsZW1lbnQoKTogYW55IHtcbiAgICBpZiAodGhpcy5fY29udGFpbmVyKSB7XG4gICAgICByZXR1cm4gdHlwZW9mKHRoaXMuX2NvbnRhaW5lcikgPT09ICdzdHJpbmcnID8gIHdpbmRvdy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRoaXMuX2NvbnRhaW5lcikgOiB0aGlzLl9jb250YWluZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnNjcm9sbFdpbmRvdyA/IHdpbmRvdyA6IHRoaXMuZWxlbWVudDtcbiAgICB9XG4gIH1cbnN0YXRpYyBkZWNvcmF0b3JzOiBEZWNvcmF0b3JJbnZvY2F0aW9uW10gPSBbXG57IHR5cGU6IERpcmVjdGl2ZSwgYXJnczogW3tcbiAgc2VsZWN0b3I6ICdbaW5maW5pdGUtc2Nyb2xsXSdcbn0sIF0gfSxcbl07XG4vKiogQG5vY29sbGFwc2UgKi9cbnN0YXRpYyBjdG9yUGFyYW1ldGVyczogKHt0eXBlOiBhbnksIGRlY29yYXRvcnM/OiBEZWNvcmF0b3JJbnZvY2F0aW9uW119fG51bGwpW10gPSBbXG57dHlwZTogRWxlbWVudFJlZiwgfSxcbnt0eXBlOiBOZ1pvbmUsIH0sXG57dHlwZTogUG9zaXRpb25SZXNvbHZlckZhY3RvcnksIH0sXG57dHlwZTogU2Nyb2xsUmVnaXN0ZXIsIH0sXG57dHlwZTogU2Nyb2xsUmVzb2x2ZXIsIH0sXG5dO1xuc3RhdGljIHByb3BEZWNvcmF0b3JzOiB7W2tleTogc3RyaW5nXTogRGVjb3JhdG9ySW52b2NhdGlvbltdfSA9IHtcbidzY3JvbGxlZCc6IFt7IHR5cGU6IE91dHB1dCB9LF0sXG4nc2Nyb2xsZWRVcCc6IFt7IHR5cGU6IE91dHB1dCB9LF0sXG4nX2Rpc3RhbmNlRG93bic6IFt7IHR5cGU6IElucHV0LCBhcmdzOiBbJ2luZmluaXRlU2Nyb2xsRGlzdGFuY2UnLCBdIH0sXSxcbidfZGlzdGFuY2VVcCc6IFt7IHR5cGU6IElucHV0LCBhcmdzOiBbJ2luZmluaXRlU2Nyb2xsVXBEaXN0YW5jZScsIF0gfSxdLFxuJ190aHJvdHRsZSc6IFt7IHR5cGU6IElucHV0LCBhcmdzOiBbJ2luZmluaXRlU2Nyb2xsVGhyb3R0bGUnLCBdIH0sXSxcbidfZGlzYWJsZWQnOiBbeyB0eXBlOiBJbnB1dCwgYXJnczogWydpbmZpbml0ZVNjcm9sbERpc2FibGVkJywgXSB9LF0sXG4nX2NvbnRhaW5lcic6IFt7IHR5cGU6IElucHV0LCBhcmdzOiBbJ2luZmluaXRlU2Nyb2xsQ29udGFpbmVyJywgXSB9LF0sXG4nc2Nyb2xsV2luZG93JzogW3sgdHlwZTogSW5wdXQsIGFyZ3M6IFsnc2Nyb2xsV2luZG93JywgXSB9LF0sXG4nX2ltbWVkaWF0ZSc6IFt7IHR5cGU6IElucHV0LCBhcmdzOiBbJ2ltbWVkaWF0ZUNoZWNrJywgXSB9LF0sXG4nX2hvcml6b250YWwnOiBbeyB0eXBlOiBJbnB1dCwgYXJnczogWydob3Jpem9udGFsJywgXSB9LF0sXG4nX2Fsd2F5c0NhbGxiYWNrJzogW3sgdHlwZTogSW5wdXQsIGFyZ3M6IFsnYWx3YXlzQ2FsbGJhY2snLCBdIH0sXSxcbidkZWJvdW5jZSc6IFt7IHR5cGU6IElucHV0IH0sXSxcbn07XG59XG5cbmludGVyZmFjZSBEZWNvcmF0b3JJbnZvY2F0aW9uIHtcbiAgdHlwZTogRnVuY3Rpb247XG4gIGFyZ3M/OiBhbnlbXTtcbn1cbiJdfQ==